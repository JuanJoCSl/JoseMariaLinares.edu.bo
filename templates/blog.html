<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè´Jos√© Mar√≠a Linares - Blog</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        main {
            max-width: 1200px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        h2 {
            text-align: center;
            font-size: 2.8rem;
            margin-bottom: 40px;
            color: #004080;
            position: relative;
            padding-bottom: 15px;
        }
        
        h2:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 5px;
            background: linear-gradient(90deg, #004080, #f0ad4e);
            border-radius: 10px;
        }
        
        .blog-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        
        .blog-card {
            background: #ffffff;
            border-radius: 15px;
            overflow: hidden;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .blog-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        .blog-card-img {
            height: 200px;
            overflow: hidden;
            position: relative;
        }
        
        .blog-card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        
        .blog-card:hover .blog-card-img img {
            transform: scale(1.1);
        }
        
        .blog-card-category {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f0ad4e;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .card-content {
            padding: 20px;
        }
        
        .card-content h3 {
            font-size: 1.4rem;
            color: #004080;
            margin-bottom: 10px;
        }
        
        .card-content p {
            font-size: 1rem;
            color: #555;
            margin-bottom: 20px;
        }
        
        .read-more {
            display: inline-block;
            padding: 8px 20px;
            background: #004080;
            color: white;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .read-more:hover {
            background: #f0ad4e;
            transform: translateX(5px);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #004080;
            font-size: 1.2rem;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            background: #fff3cd;
            color: #856404;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }
        
        .api-status {
            padding: 10px;
            margin: 10px 0 20px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.5s;
        }
        .fade-enter, .fade-leave-to {
            opacity: 0;
        }
        
        .retry-btn {
            padding: 10px 20px;
            background: #004080;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .retry-btn:hover {
            background: #00264d;
        }
        
        @media (max-width: 768px) {
            h2 {
                font-size: 2.2rem;
            }
            
            .blog-card {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="row"><img src="../img/icono.jpg" width="100px"></div>
        <div class="rowq">
            <h1>Jos√© Mar√≠a Linares</h1>
            <p class="slogan">Con orden, trabajo y estudio... Adelante Linares</p>
        </div>
    </header>

    <main id="app">
        <h2>üì£ Voces Estudiantiles (BLOG)</h2>
        
        <div v-if="apiStatus" class="api-status" :class="apiStatusClass">
            {{ apiStatus }}
        </div>
        
        <div v-if="loading" class="loading">
            <p>Cargando entradas del blog...</p>
        </div>
        
        <div v-else-if="error" class="error">
            <p>{{ error }}</p>
            <button @click="fetchPosts" class="retry-btn">Reintentar Conexi√≥n</button>
        </div>
        
        <div v-else-if="posts.length === 0" class="empty-state">
            <p>No hay entradas disponibles en este momento.</p>
            <button @click="fetchPosts" class="retry-btn">Reintentar</button>
        </div>
        
        <transition-group name="fade" tag="div" class="blog-container" v-else>
            <div v-for="post in posts" :key="post.id" class="blog-card">
                <div class="blog-card-img">
                    <img :src="post.imagen || '../img/ejercicio.avif'" :alt="post.titulo" @error="handleImageError">
                    <div class="blog-card-category">{{ post.categoria || 'General' }}</div>
                </div>
                <div class="card-content">
                    <h3>{{ post.titulo }}</h3>
                    <p>{{ post.contenido }}</p>
                    <p><small>{{ formatDate(post.fecha) }}</small></p>
                    <a href="#" class="read-more">Leer m√°s</a>
                </div>
            </div>
        </transition-group>
    </main>

    <footer>
        <p>&copy; 2025 Unidad Educativa Jos√© Mar√≠a Linares</p>
    </footer>
    
    <script>
      const API_BASE_URL = 'https://josemarialinares-api.onrender.com';
      
      new Vue({
        el: '#app',
        data: {
          loading: true,
          error: null,
          apiStatus: '',
          posts: []
        },
        computed: {
          apiStatusClass() {
            if (this.apiStatus.includes('√©xito') || this.apiStatus.includes('cargad') || this.apiStatus.includes('OK')) {
              return 'status-success';
            } else if (this.apiStatus.includes('Error') || this.apiStatus.includes('fall√≥')) {
              return 'status-error';
            }
            return 'status-warning';
          }
        },
        mounted() {
          this.fetchPosts();
          // Recargar posts cada 5 minutos
          setInterval(() => {
            if (!this.loading) this.fetchPosts();
          }, 300000);
        },
        methods: {
          async fetchPosts() {
            this.loading = true;
            this.error = null;
            
            try {
              // Primero verificamos el estado del servidor
              try {
                const healthResponse = await axios.get(`${API_BASE_URL}/health`, { 
                  timeout: 10000 
                });
                if (healthResponse.data && healthResponse.data.status === 'ok') {
                  this.apiStatus = '‚úÖ Servidor disponible y funcionando';
                }
              } catch (healthError) {
                console.warn('Health check no disponible:', healthError.message);
              }
              
              // Ahora obtenemos los posts del blog
              const response = await axios.get(`${API_BASE_URL}/api/blog`, { timeout: 15000 });
              
              if (response.data && Array.isArray(response.data)) {
                this.posts = response.data;
                this.apiStatus = `‚úÖ ${response.data.length} entradas cargadas exitosamente`;
              } else {
                throw new Error('Formato de respuesta inv√°lido');
              }
              
            } catch (apiError) {
              console.error('Error al cargar posts del blog:', apiError);
              
              // An√°lisis detallado del error
              if (apiError.code === 'ECONNABORTED') {
                this.error = "Tiempo de espera agotado. El servidor puede estar iniciando (en Render.com puede tomar hasta 2 minutos en el primer acceso).";
                this.apiStatus = '‚è∞ Timeout - Servidor no respondi√≥ a tiempo';
              } else if (apiError.response) {
                const status = apiError.response.status;
                if (status === 404) {
                  this.error = "Endpoint no encontrado (404). Verifica que la URL sea correcta.";
                  this.apiStatus = '‚ùå Error 404 - Endpoint no encontrado';
                } else if (status === 500) {
                  this.error = "Error interno del servidor (500). Por favor, intente m√°s tarde.";
                  this.apiStatus = '‚ùå Error 500 - Error interno del servidor';
                } else {
                  this.error = `Error del servidor: ${status} ${apiError.response.statusText}`;
                  this.apiStatus = `‚ùå Error ${status} - ${apiError.response.statusText}`;
                }
              } else if (apiError.request) {
                this.error = "No se pudo conectar con el servidor. Verifique: 1) La URL es correcta, 2) El servidor est√° ejecut√°ndose en Render.com, 3) No hay problemas de red.";
                this.apiStatus = 'üåê Error de Red - No se pudo conectar al servidor';
              } else {
                this.error = "Error inesperado en la configuraci√≥n de la petici√≥n.";
                this.apiStatus = '‚öôÔ∏è Error de Configuraci√≥n';
              }
              
              // Cargar datos de ejemplo como respaldo
              this.loadExampleData();
              
            } finally {
              this.loading = false;
            }
          },
          
          loadExampleData() {
            // Datos de ejemplo para cuando la API no est√© disponible
            this.posts = [
              {
                id: 1,
                titulo: '¬°Campeones del Torneo!',
                contenido: 'Resumen de la emocionante final de f√∫tbol sala donde nuestros estudiantes demostraron su talento y dedicaci√≥n.',
                imagen: 'Deportes',
                fecha: '2025-10-15',
                created_at: new Date().toISOString()
              },
              {
                id: 2,
                titulo: 'Nuevo Laboratorio de Ciencias',
                contenido: 'Inauguramos nuestro moderno laboratorio de ciencias equipado con tecnolog√≠a de √∫ltima generaci√≥n.',
                imagen: 'Ciencia',
                fecha: '2025-10-10',
                created_at: new Date().toISOString()
              },
              {
                id: 3,
                titulo: 'Festival de Arte Estudiantil',
                contenido: 'Los estudiantes presentaron sus obras en el festival anual de arte, mostrando incre√≠ble talento y creatividad.',
                imagen: 'Arte',
                fecha: '2025-10-05',
                created_at: new Date().toISOString()
              }
            ];
            
            if (!this.apiStatus.includes('Error')) {
              this.apiStatus = '‚ö†Ô∏è Usando datos de ejemplo - Verifica la conexi√≥n con el servidor';
            }
          },
          
          formatDate(dateString) {
            if (!dateString) return '';
            
            const options = { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric'
            };
            try {
              const date = new Date(dateString);
              return 'Publicado el ' + date.toLocaleDateString('es-ES', options);
            } catch (e) {
              return dateString;
            }
          }
        }
      });
    </script>
</body>
</html>