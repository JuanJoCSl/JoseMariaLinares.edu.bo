<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè´ Jos√© Mar√≠a Linares - Horarios</title>
    <link rel="stylesheet" href="../css/styles.css">
    <!-- Vue.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- Axios para peticiones HTTP -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
    main {
      padding: 30px;
      max-width: 800px;
      margin: auto;
      font-family: "Segoe UI", Arial, sans-serif;
    }

    h2 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 20px;
      color: #004080;
    }

    .horario {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      border-left: 6px solid #804000;
      transition: transform 0.2s ease;
      margin-bottom: 25px;
    }

    .horario:hover {
      transform: translateY(-5px);
    }

    .horario img {
      display: block;
      width: 100%;
      max-width: 600px;
      height: auto;
      margin: 10px auto;
      border-radius: 8px;
      border: 2px solid #804000;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #004080;
      font-size: 1.2rem;
    }
    
    .error {
      text-align: center;
      padding: 20px;
      background: #fff3cd;
      color: #856404;
      border-radius: 10px;
      margin: 20px 0;
      border: 1px solid #ffeaa7;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-style: italic;
    }
    
    .horario-date {
      text-align: right;
      font-size: 0.9rem;
      color: #666;
      margin-top: 10px;
    }
    
    .retry-btn {
      padding: 10px 20px;
      background: #004080;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      font-weight: bold;
    }
    
    .retry-btn:hover {
      background: #00264d;
    }
    
    .debug-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
      font-size: 0.9rem;
      color: #6c757d;
    }
    
    .api-status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .fade-enter-active, .fade-leave-active {
      transition: opacity 0.5s;
    }
    .fade-enter, .fade-leave-to {
      opacity: 0;
    }
    
    .horario-title {
      text-align: center;
      color: #004080;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
</style>
</head>
<body>
    <header>
	<div class="row"><img src="../img/icono.jpg" width="100px" ></div>
	<div class="rowq">
        <h1>Jos√© Mar√≠a Linares</h1>
        <p class="slogan">Con orden, trabajo y estudio... Adelante Linares</p>
	</div>
    </header>

    <main id="app">
	<h2>üìã Horarios de Clases</h2>
    
    <!-- Estado de la API -->
    <div v-if="apiStatus" class="api-status" :class="apiStatusClass">
      {{ apiStatus }}
    </div>
    
    <!-- Informaci√≥n de depuraci√≥n -->
    <div v-if="showDebug" class="debug-info">
      <strong>Informaci√≥n de Depuraci√≥n:</strong><br>
      URL Base: {{ apiBaseUrl }}<br>
      Endpoint: {{ currentEndpoint }}<br>
      Estado: {{ connectionStatus }}<br>
      <button @click="toggleDebug" class="retry-btn" style="background: #6c757d; margin-top: 5px;">
        Ocultar Info
      </button>
    </div>
    
    <!-- Estado de carga -->
    <div v-if="loading" class="loading">
      <p>Cargando horarios...</p>
    </div>
    
    <!-- Mensaje de error -->
    <div v-else-if="error" class="error">
      <p>{{ error }}</p>
      <button @click="fetchHorarios" class="retry-btn">Reintentar Conexi√≥n</button>
      <button @click="toggleDebug" class="retry-btn" style="background: #6c757d; margin-left: 10px;">
        {{ showDebug ? 'Ocultar' : 'Mostrar' }} Info T√©cnica
      </button>
    </div>
    
    <!-- Estado vac√≠o -->
    <div v-else-if="horarios.length === 0" class="empty-state">
      <p>No hay horarios disponibles en este momento.</p>
      <button @click="fetchHorarios" class="retry-btn">Reintentar</button>
    </div>
    
    <!-- Lista de horarios -->
    <transition-group name="fade" tag="div">
      <div v-for="horario in horarios" :key="horario.id" class="horario">
        <div class="horario-title">
          <h3>{{ horario.titulo }}</h3>
        </div>
        
        <div v-if="horario.imagen">
          <img :src="horario.imagen" :alt="horario.titulo || 'Horario'" @error="handleImageError">
        </div>
        
        <div class="horario-date" v-if="horario.fecha">
          Vigente desde: {{ formatDate(horario.fecha) }}
        </div>
      </div>
    </transition-group>
    </main>

    <footer>
        <p>&copy; 2025 Unidad Educativa Jos√© Mar√≠a Linares</p>
    </footer>
    
    <script>
      // CONFIGURACI√ìN - ACTUALIZA ESTA URL CON LA DE TU APLICACI√ìN EN RENDER.COM
      const API_BASE_URL = 'https://josemarialinares-api.onrender.com'; // Cambia por tu URL real de Render
      
      new Vue({
        el: '#app',
        data: {
          loading: true,
          error: null,
          showDebug: false,
          apiStatus: '',
          connectionStatus: 'Iniciando...',
          apiBaseUrl: API_BASE_URL,
          currentEndpoint: '/api/horarios',
          horarios: []
        },
        computed: {
          apiStatusClass() {
            if (this.apiStatus.includes('√©xito') || this.apiStatus.includes('conectado') || this.apiStatus.includes('OK')) {
              return 'status-success';
            } else if (this.apiStatus.includes('Error') || this.apiStatus.includes('fall√≥')) {
              return 'status-error';
            } else {
              return 'status-warning';
            }
          }
        },
        mounted() {
          this.fetchHorarios();
          // Recargar horarios cada 10 minutos
          setInterval(() => {
            if (!this.loading) {
              this.fetchHorarios();
            }
          }, 600000);
        },
        methods: {
          async fetchHorarios() {
            this.loading = true;
            this.error = null;
            this.connectionStatus = 'Verificando conexi√≥n con el servidor...';
            
            try {
              // Primero verificamos el endpoint de health
              try {
                const healthResponse = await axios.get(`${API_BASE_URL}/health`, { 
                  timeout: 10000 
                });
                
                if (healthResponse.data && healthResponse.data.status === 'ok') {
                  this.connectionStatus = `Servidor conectado - ${healthResponse.data.message || 'OK'}`;
                  this.apiStatus = '‚úÖ ' + (healthResponse.data.message || 'Servidor disponible y funcionando');
                } else {
                  this.connectionStatus = 'Health check respondi√≥ pero con estado inesperado';
                  this.apiStatus = '‚ö†Ô∏è Servidor respondi√≥ pero con estado inesperado';
                }
                console.log('Health check exitoso:', healthResponse.data);
              } catch (healthError) {
                this.connectionStatus = 'Health check fall√≥, pero continuamos con el endpoint principal...';
                console.warn('Health check no disponible:', healthError.message);
              }
              
              // Ahora obtenemos los horarios
              this.connectionStatus = 'Obteniendo horarios...';
              const response = await axios.get(`${API_BASE_URL}/api/horarios`, { 
                timeout: 15000 
              });
              
              if (response.data && Array.isArray(response.data)) {
                this.horarios = response.data;
                this.connectionStatus = `Horarios cargados: ${response.data.length} encontrados`;
                this.apiStatus = `‚úÖ ${response.data.length} horarios cargados exitosamente`;
                console.log('Horarios cargados:', this.horarios);
              } else {
                throw new Error('Formato de respuesta inv√°lido');
              }
              
            } catch (apiError) {
              console.error('Error al cargar desde API:', apiError);
              this.connectionStatus = `Error: ${apiError.message}`;
              
              // An√°lisis detallado del error
              if (apiError.code === 'ECONNABORTED') {
                this.error = "Tiempo de espera agotado. El servidor puede estar iniciando (en Render.com puede tomar hasta 2 minutos en el primer acceso).";
                this.apiStatus = '‚è∞ Timeout - Servidor no respondi√≥ a tiempo';
              } else if (apiError.response) {
                const status = apiError.response.status;
                if (status === 404) {
                  this.error = "Endpoint no encontrado (404). Verifica que la URL sea correcta.";
                  this.apiStatus = '‚ùå Error 404 - Endpoint no encontrado';
                } else if (status === 500) {
                  this.error = "Error interno del servidor (500). Por favor, intente m√°s tarde.";
                  this.apiStatus = '‚ùå Error 500 - Error interno del servidor';
                } else {
                  this.error = `Error del servidor: ${status} ${apiError.response.statusText}`;
                  this.apiStatus = `‚ùå Error ${status} - ${apiError.response.statusText}`;
                }
              } else if (apiError.request) {
                this.error = "No se pudo conectar con el servidor. Verifique: 1) La URL es correcta, 2) El servidor est√° ejecut√°ndose en Render.com, 3) No hay problemas de red.";
                this.apiStatus = 'üåê Error de Red - No se pudo conectar al servidor';
              } else {
                this.error = "Error inesperado en la configuraci√≥n de la petici√≥n.";
                this.apiStatus = '‚öôÔ∏è Error de Configuraci√≥n';
              }
              
              // Cargar datos de ejemplo como respaldo
              this.loadExampleData();
              
            } finally {
              this.loading = false;
            }
          },
          
          loadExampleData() {
            // Datos de ejemplo para cuando la API no est√© disponible
            this.horarios = [
              {
                id: 1,
                titulo: "Horario General de Clases",
                imagen: "../img/horario_general.png",
                fecha: "2025-01-01"
              },
              {
                id: 2,
                titulo: "Horario Lunes a Jueves",
                imagen: "../img/horario_lun_jue.png",
                fecha: "2025-01-01"
              },
              {
                id: 3,
                titulo: "Horario Viernes",
                imagen: "../img/horario_viernes.png",
                fecha: "2025-01-01"
              }
            ];
            
            if (!this.apiStatus.includes('Error')) {
              this.apiStatus = '‚ö†Ô∏è Usando datos de ejemplo - Verifica la conexi√≥n con el servidor';
            }
          },
          
          toggleDebug() {
            this.showDebug = !this.showDebug;
          },
          
          formatDate(dateString) {
            if (!dateString) return '';
            
            const options = { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric'
            };
            try {
              const date = new Date(dateString);
              return date.toLocaleDateString('es-ES', options);
            } catch (e) {
              return dateString;
            }
          },
          
          handleImageError(event) {
            console.warn('Error cargando imagen:', event.target.src);
            event.target.style.display = 'none';
          }
        }
      });
    </script>
</body>
</html>